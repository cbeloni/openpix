name: Deploy production

on:
  push:
    branches: [ main ]

jobs:
  remote-ssh:
    runs-on: ubuntu-latest
    environment:
      name: open-pix
    steps:
      - name: executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: 177.93.128.55
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 1m
          script_stop: true
          script: | 
            cd /home/ubuntu/api/deploy-openpix/
            [ -d openpix ] && rm -rf openpix
            git clone https://${{ secrets.GIT_USER }}:${{ secrets.GIT_TOKEN }}@github.com/cbeloni/openpix.git
            cd openpix 
            chmod +x mvnw
            ./mvnw package
            cd ..
            PIDS=$(ps -ef | grep openpix-0.0.1-SNAPSHOT.jar | awk '{print $2}')
            echo "Matando processo com os PIDs $PIDS"
            echo $PIDS | tr ' ' '\n' | xargs sudo kill
            echo "Iniciando aplicação..."
            chmod +x openpix/target/openpix-0.0.1-SNAPSHOT.jar
            sudo java -jar -Dserver.port=80 openpix/target/openpix-0.0.1-SNAPSHOT.jar > logs.txt &
            echo "Aplicação iniciada com sucesso"
            
